USE [ERPDBTRAIN]
GO
/****** Object:  StoredProcedure [dbo].[ANDR_QA_GetPartInsRCVInfo]    Script Date: 11/3/2025 2:02:19 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 
 
ALTER PROC [dbo].[ANDR_QA_GetPartInsRCVInfo]
	@Company nvarchar(10)
	--,@Site nvarchar(50)
	,@PONum int
	,@PackSlip nvarchar(50)
	,@PackLine int
As
select	PT.TranType
	,PT.PartNum
	,iif(PT.TranType='PUR-INS',SUM(PT.TranQty),0) ReceivedQTy
	,iif(PT.TranType='INS-STK',SUM(PT.TranQty),0) QAPassedQTy
	,cast(0 as decimal(20,2)) DMRAccept
	,cast(0 as decimal(20,2)) RejectQTy
	,PT.UM
	,PT.LotNum
	,PT.PONum
	,PT.PackSlip
	,PT.PackLine
		,PT.Company
INTO #tbParttran
from Erp.PartTran PT with (nolock) 
where PT.Company = @Company 
	--and PT.Plant = @Site
	AND PT.PONum = @PONum
	AND PT.PackSlip = @PackSlip
	AND PT.PackLine= @PackLine
	 AND (TranType IN ('PUR-INS','INS-STK', 'PUR-STK'))
group by PT.PartNum,PT.UM,PT.LotNum,PT.Company,PT.PONum,PT.PackSlip,PT.PackLine,PT.TranType
UNION 
select	PT.ActionType
	,B.PartNum
	,0
	,0
	,iif(PT.ActionType='A',SUM(PT.Quantity),0) DMRAccept
	,iif(PT.ActionType='R',SUM(PT.Quantity),0) RejectQTy
	,PT.CreditUM
	,B.LotNum
	,B.PONum
	,PT.PackSlip
	,PT.PackLine
		,PT.Company
from Erp.DMRActn PT with (nolock) 
	INNER join ERP.DMRHead B with (nolock) on PT.Company = B.COmpany and PT.DMRNum=B.DMRNum
where PT.Company = @Company 
	AND PT.PackSlip = @PackSlip
	AND PT.PackLine= @PackLine
group by B.PartNum,PT.CreditUM,B.LotNum,PT.Company,B.PONum,PT.PackSlip,PT.PackLine,PT.ActionType
 
select 
	PartNum
	,sum(ReceivedQTy)-sum(RejectQTy) TotalAccQTy
	,sum(ReceivedQTy) ReceivedQTy
	,sum(QAPassedQTy) QAPassedQTy
	, sum(RejectQTy) RejectQTy
	,sum(DMRAccept) DMRAccQTy
	,UM
	,LotNum
	,PONum
	,PackSlip
	,PackLine
		,Company
from #tbParttran
group by PartNum,UM
	,LotNum
	,PONum
	,PackSlip
	,PackLine
		,Company
 
drop table #tbParttran
